{% extends "base.html" %}

{% block title %}Procedures Catalog - Medical Records{% endblock %}

{% block content %}
<div class="container">
    <div class="row mb-4">
        <div class="col-12">
            <h1><i class="bi bi-scissors"></i> Medical Procedures Catalog</h1>
            <p class="text-muted">Browse and search medical procedures with statistics</p>
        </div>
    </div>

    <!-- Search/Filter Form -->
    <div class="search-form">
        <h5 class="mb-3"><i class="bi bi-search"></i> Search Procedures</h5>
        <form method="GET" action="/procedures">
            <div class="row g-3">
                <div class="col-md-8">
                    <label for="search" class="form-label">Procedure Name or ICD Code</label>
                    <input type="text" class="form-control" id="search" name="search"
                           value="{{ search }}" placeholder="e.g., cardiac catheterization, appendectomy, 0D16">
                </div>
                <div class="col-md-4">
                    <label for="icd_version" class="form-label">ICD Version</label>
                    <select class="form-select" id="icd_version" name="icd_version">
                        <option value="">All Versions</option>
                        <option value="9" {% if request.args.get('icd_version') == '9' %}selected{% endif %}>ICD-9</option>
                        <option value="10" {% if request.args.get('icd_version') == '10' %}selected{% endif %}>ICD-10</option>
                    </select>
                </div>
            </div>
            <div class="row mt-3">
                <div class="col-12">
                    <button type="submit" class="btn btn-primary">
                        <i class="bi bi-search"></i> Search
                    </button>
                    <a href="/procedures" class="btn btn-secondary">
                        <i class="bi bi-x-circle"></i> Clear
                    </a>
                    <span class="ms-3 text-muted">
                        <i class="bi bi-info-circle"></i> Found {{ procedures|length }} procedure(s)
                    </span>
                </div>
            </div>
        </form>
    </div>

    <!-- Statistics Cards -->
    {% if procedures %}
    <div class="row g-3 mb-4">
        <div class="col-md-4">
            <div class="card text-center">
                <div class="card-body">
                    <i class="bi bi-list-check text-primary" style="font-size: 2rem;"></i>
                    <h4 class="mt-2">{{ procedures|length }}</h4>
                    <p class="text-muted mb-0">Procedures Listed</p>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card text-center">
                <div class="card-body">
                    <i class="bi bi-people text-success" style="font-size: 2rem;"></i>
                    <h4 class="mt-2">{{ procedures|sum(attribute='patient_count') or 0 }}</h4>
                    <p class="text-muted mb-0">Total Patient Procedures</p>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card text-center">
                <div class="card-body">
                    <i class="bi bi-activity text-danger" style="font-size: 2rem;"></i>
                    <h4 class="mt-2">{{ procedures|sum(attribute='procedure_count') or 0 }}</h4>
                    <p class="text-muted mb-0">Total Procedures Performed</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Procedures Table -->
    <div class="card">
        <div class="card-header">
            <i class="bi bi-table"></i> Procedure Catalog (Sorted by Frequency)
        </div>
        <div class="card-body p-0">
            <div class="table-responsive">
                <table class="table table-hover mb-0">
                    <thead class="table-light">
                        <tr>
                            <th width="10%">ICD Code</th>
                            <th width="5%">Ver</th>
                            <th width="40%">Procedure Name</th>
                            <th width="10%" class="text-center">Patients</th>
                            <th width="10%" class="text-center">Performed</th>
                            <th width="12%">First Done</th>
                            <th width="12%">Last Done</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for procedure in procedures %}
                        <tr>
                            <td><code>{{ procedure.icd_code }}</code></td>
                            <td><span class="badge bg-secondary">{{ procedure.icd_version }}</span></td>
                            <td>
                                <strong>{{ procedure.procedure_name[:60] }}</strong>
                                {% if procedure.procedure_name|length > 60 %}...{% endif %}
                            </td>
                            <td class="text-center">
                                {% if procedure.patient_count %}
                                    <span class="badge bg-primary fs-6">{{ procedure.patient_count }}</span>
                                {% else %}
                                    <span class="text-muted">0</span>
                                {% endif %}
                            </td>
                            <td class="text-center">
                                {% if procedure.procedure_count %}
                                    <span class="badge bg-success fs-6">{{ procedure.procedure_count }}</span>
                                {% else %}
                                    <span class="text-muted">0</span>
                                {% endif %}
                            </td>
                            <td>
                                {% if procedure.first_performed %}
                                    <small>{{ procedure.first_performed }}</small>
                                {% else %}
                                    <span class="text-muted">-</span>
                                {% endif %}
                            </td>
                            <td>
                                {% if procedure.last_performed %}
                                    <small>{{ procedure.last_performed }}</small>
                                {% else %}
                                    <span class="text-muted">-</span>
                                {% endif %}
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
        <div class="card-footer text-muted">
            <small>
                <i class="bi bi-info-circle"></i>
                Showing top 100 procedures sorted by frequency. Use search to find specific procedures.
                Data aggregated from procedures_performed table with patient and procedure counts.
            </small>
        </div>
    </div>
    {% else %}
    <div class="alert alert-info">
        <i class="bi bi-info-circle"></i>
        {% if search %}
            No procedures found matching "{{ search }}". Try a different search term.
        {% else %}
            No procedures available in the database.
        {% endif %}
    </div>
    {% endif %}

    <!-- Common Procedures Breakdown -->
    {% if procedures %}
    <div class="card mt-4">
        <div class="card-header">
            <i class="bi bi-bar-chart"></i> Most Common Procedures
        </div>
        <div class="card-body">
            <div class="row">
                {% set top_procedures = procedures[:10] %}
                {% for proc in top_procedures %}
                <div class="col-md-6 mb-2">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <strong>{{ loop.index }}.</strong>
                            <small>{{ proc.procedure_name[:50] }}{% if proc.procedure_name|length > 50 %}...{% endif %}</small>
                        </div>
                        <span class="badge bg-primary">{{ proc.procedure_count }} times</span>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Info Card -->
    <div class="card mt-4">
        <div class="card-header">
            <i class="bi bi-info-circle"></i> About This Catalog
        </div>
        <div class="card-body">
            <p>
                This procedure catalog shows all medical procedures available in the database along with usage statistics.
                Each procedure includes its ICD code, version, and comprehensive performance statistics.
            </p>
            <p class="mb-0">
                <strong>Technical Details:</strong> Uses complex SQL aggregation with GROUP BY, COUNT DISTINCT, and LEFT JOINs
                between the procedures and procedures_performed tables. Shows both unique patient counts and total procedure
                counts to distinguish between procedures performed once vs. multiple times.
            </p>
        </div>
    </div>
</div>
{% endblock %}
